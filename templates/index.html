<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB í…Œì´ë¸” êµ¬ì¡° ë¹„êµ ë´‡</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“‹ GAT Weekly Tasks Report</h1>
            <p>ì›”ìš”ì¼ê³¼ ê¸ˆìš”ì¼ì˜ ì—…ë¬´ ëª©ë¡ì„ ìº¡ì²˜í•˜ì—¬ ë¶„ì„í•˜ì„¸ìš”</p>
        </header>

        <div class="upload-section">
            <div class="group-container">
                <div class="group-box">
                    <h3>ğŸ“… ì›”ìš”ì¼</h3>
                    <div class="date-selector">
                        <div class="date-dropdown" id="monday-date-dropdown">
                            <button class="date-button" id="monday-date-button">
                                <span id="monday-selected-date">ë‚ ì§œ ì„ íƒ</span>
                                <span class="dropdown-arrow">â–¼</span>
                            </button>
                            <div class="calendar-popup" id="monday-calendar">
                                <div class="calendar-header">
                                    <button class="calendar-nav" id="monday-prev-month">â€¹</button>
                                    <span class="calendar-title" id="monday-month-year"></span>
                                    <button class="calendar-nav" id="monday-next-month">â€º</button>
                                </div>
                                <div class="calendar-grid" id="monday-calendar-grid"></div>
                            </div>
                        </div>
                    </div>
                    <div class="upload-area drop-zone" id="monday-upload" data-group="monday">
                        <input type="file" id="monday-file" accept="image/*" multiple>
                        <label for="monday-file">
                            <div class="upload-text">
                                <div class="drop-icon">ğŸ“</div>
                                <span>í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸</span>
                                <small>PNG, JPG, GIF, BMP, WEBP</small>
                            </div>
                        </label>
                        <div class="drop-overlay">
                            <div class="drop-content">
                                <div class="drop-icon">â¬‡ï¸</div>
                                <span>ì—¬ê¸°ì— íŒŒì¼ì„ ë†“ìœ¼ì„¸ìš”</span>
                            </div>
                        </div>
                    </div>
                    <div class="image-list">
                        {% for image in monday_images %}
                        <div class="image-item">{{ image }}</div>
                        {% endfor %}
                    </div>
                    <button class="clear-btn" onclick="clearGroup('monday')">ì´ˆê¸°í™”</button>
                </div>

                <div class="group-box">
                    <h3>ğŸ‰ ê¸ˆìš”ì¼</h3>
                    <div class="date-selector">
                        <div class="date-dropdown" id="friday-date-dropdown">
                            <button class="date-button" id="friday-date-button">
                                <span id="friday-selected-date">ë‚ ì§œ ì„ íƒ</span>
                                <span class="dropdown-arrow">â–¼</span>
                            </button>
                            <div class="calendar-popup" id="friday-calendar">
                                <div class="calendar-header">
                                    <button class="calendar-nav" id="friday-prev-month">â€¹</button>
                                    <span class="calendar-title" id="friday-month-year"></span>
                                    <button class="calendar-nav" id="friday-next-month">â€º</button>
                                </div>
                                <div class="calendar-grid" id="friday-calendar-grid"></div>
                            </div>
                        </div>
                    </div>
                    <div class="upload-area drop-zone" id="friday-upload" data-group="friday">
                        <input type="file" id="friday-file" accept="image/*" multiple>
                        <label for="friday-file">
                            <div class="upload-text">
                                <div class="drop-icon">ğŸ“</div>
                                <span>í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸</span>
                                <small>PNG, JPG, GIF, BMP, WEBP</small>
                            </div>
                        </label>
                        <div class="drop-overlay">
                            <div class="drop-content">
                                <div class="drop-icon">â¬‡ï¸</div>
                                <span>ì—¬ê¸°ì— íŒŒì¼ì„ ë†“ìœ¼ì„¸ìš”</span>
                            </div>
                        </div>
                    </div>
                    <div class="image-list">
                        {% for image in friday_images %}
                        <div class="image-item">{{ image }}</div>
                        {% endfor %}
                    </div>
                    <button class="clear-btn" onclick="clearGroup('friday')">ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <div class="action-section">
            <button id="compare-btn" class="compare-btn">ğŸ” ë¶„ì„ ì‹œì‘</button>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Claudeê°€ ì—…ë¬´ ëª©ë¡ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <div id="result-section" class="result-section hidden">
            <!-- ë…¸ì…˜ DB ë¶„ì„ ì˜ì—­ - ì„ì‹œ ìˆ¨ê¹€ -->
            <div id="notion-analysis" class="notion-analysis" style="display: none;">
                <h3>ğŸ“Š DB ì§ì ‘ ë¶„ì„</h3>
                <div class="notion-controls">
                    <button id="notion-analyze-btn" class="notion-btn">ğŸ” ë…¸ì…˜ DB ë¶„ì„ ì‹œì‘</button>
                </div>
                <div id="notion-loading" class="notion-loading hidden">
                    <div class="spinner"></div>
                    <p>ë…¸ì…˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
                <div id="notion-results" class="notion-results hidden">
                    <div class="notion-summary">
                        <div class="summary-card">
                            <h4>ğŸ“… ì›”ìš”ì¼</h4>
                            <div class="task-count" id="monday-task-count">0</div>
                            <span>ê°œ ì—…ë¬´</span>
                        </div>
                        <div class="summary-card">
                            <h4>ğŸ‰ ê¸ˆìš”ì¼</h4>
                            <div class="task-count" id="friday-task-count">0</div>
                            <span>ê°œ ì—…ë¬´</span>
                        </div>
                    </div>
                    
                    <div class="notion-charts">
                        <div class="chart-container">
                            <h4>ğŸ“ˆ ìƒíƒœë³„ ì—…ë¬´ ë³€í™”</h4>
                            <div id="status-chart" class="chart-content"></div>
                        </div>
                        
                        <div class="chart-container">
                            <h4>ğŸ¯ ìš°ì„ ìˆœìœ„ ë¶„í¬</h4>
                            <div id="priority-chart" class="chart-content"></div>
                        </div>
                        
                        <div class="chart-container">
                            <h4>ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ì—…ë¬´</h4>
                            <div id="category-chart" class="chart-content"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="image-comparison" class="image-comparison hidden">
                <h3>ğŸ” ì´ë¯¸ì§€ë¡œ ë³´ê¸°</h3>
                <div class="comparison-container">
                    <div class="comparison-group">
                        <h4>ğŸ“… ì›”ìš”ì¼</h4>
                        <div id="monday-images-display" class="images-display"></div>
                    </div>
                    <div class="comparison-group">
                        <h4>ğŸ‰ ê¸ˆìš”ì¼</h4>
                        <div id="friday-images-display" class="images-display"></div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼</h2>
            <div class="date-range-info" id="date-range-info">
                <span id="date-range-text">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>
            </div>
            <div id="analysis-result"></div>
        </div>
    </div>

    <div id="message" class="message hidden"></div>

    <script>
        function uploadImages(group, files) {
            const formData = new FormData();
            
            Array.from(files).forEach(file => {
                formData.append('file', file);
                formData.append('group', group);
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage(data.error, 'error');
                    }
                })
                .catch(error => {
                    showMessage('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            });
        }

        function clearGroup(group) {
            if (confirm(`${group === 'monday' ? 'ì›”ìš”ì¼' : 'ê¸ˆìš”ì¼'}ì˜ ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch(`/clear/${group}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage(data.error, 'error');
                    }
                })
                .catch(error => {
                    showMessage('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        }

        function compareImages() {
            const loading = document.getElementById('loading');
            const resultSection = document.getElementById('result-section');
            const compareBtn = document.getElementById('compare-btn');

            loading.classList.remove('hidden');
            resultSection.classList.add('hidden');
            compareBtn.disabled = true;

            fetch('/compare', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.add('hidden');
                compareBtn.disabled = false;

                if (data.success) {
                    const analysisResult = document.getElementById('analysis-result');
                    
                    // ë¶„ì„ ê²°ê³¼ë¥¼ í‘œ í˜•íƒœë¡œ ë³€í™˜
                    const tableHtml = convertAnalysisToTable(data.analysis, data.monday_count, data.friday_count);
                    analysisResult.innerHTML = tableHtml;
                    
                    // ì´ë¯¸ì§€ ë¹„êµ ì„¹ì…˜ í‘œì‹œ
                    displayImageComparison(data.monday_images, data.friday_images);
                    
                    resultSection.classList.remove('hidden');
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                loading.classList.add('hidden');
                compareBtn.disabled = false;
                showMessage('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');

            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        function setupDropZone(dropZone) {
            const group = dropZone.dataset.group;
            const fileInput = dropZone.querySelector('input[type="file"]');
            const dropOverlay = dropZone.querySelector('.drop-overlay');

            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë°©ì§€
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // ë“œë˜ê·¸ ì§„ì…/ë²—ì–´ë‚¨ ì‹œê° íš¨ê³¼
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                    dropOverlay.style.display = 'flex';
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                    dropOverlay.style.display = 'none';
                }, false);
            });

            // ë“œë¡­ ì²˜ë¦¬
            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    uploadImages(group, files);
                }
            }
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('monday-file').addEventListener('change', function(e) {
            uploadImages('monday', e.target.files);
        });

        document.getElementById('friday-file').addEventListener('change', function(e) {
            uploadImages('friday', e.target.files);
        });

        // ë¶„ì„ ê²°ê³¼ë¥¼ í‘œ í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function convertAnalysisToTable(analysis, mondayCount, fridayCount) {
            // "ë„¤, ë‘ ì´ë¯¸ì§€ë¥¼ ë¹„êµ ë¶„ì„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤" ë¬¸êµ¬ ì œê±°
            analysis = analysis.replace(/ë„¤,?\s*ë‘\s*ì´ë¯¸ì§€ë¥¼?\s*ë¹„êµ\s*ë¶„ì„í•´?\s*ë“œë¦¬ê² ìŠµë‹ˆë‹¤\.?\s*/gi, '');
            
            // ë¶„ì„ ê²°ê³¼ë¥¼ 4ê°œ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ„ê¸° - ë” ì •í™•í•œ íŒ¨í„´ ë§¤ì¹­
            const sectionPattern = /(\d+)\.\s*\*\*([^*]+)\*\*:\s*([^]*?)(?=\d+\.\s*\*\*|$)/g;
            const sections = [];
            let match;
            
            while ((match = sectionPattern.exec(analysis)) !== null) {
                sections.push({
                    number: parseInt(match[1]),
                    title: match[2].trim(),
                    content: match[3].trim()
                });
            }
            
            const sectionTitles = [
                'ì›”ìš”ì¼ O, ê¸ˆìš”ì¼ X',
                'ì›”ìš”ì¼ X, ê¸ˆìš”ì¼ O', 
                'ì§„í–‰ë¥  ë³€ê²½',
                'ë³€ë™ ì—†ìŒ (ì¡°ì •/ì¡°ìœ¨ ê³ ë ¤)'
            ];
            
            let tableHtml = `
                <div class="analysis-table-container">
                    <table class="analysis-table">
                        <tbody>
                            <tr class="title-row">
            `;
            
            // 1í–‰: ì œëª©ë“¤
            for (let i = 0; i < 4; i++) {
                const title = sectionTitles[i];
                tableHtml += `<th class="section-title">${title}</th>`;
            }
            
            tableHtml += `
                            </tr>
                            <tr class="content-row">
            `;
            
            // 2í–‰: ë‚´ìš©ë“¤ - ì„¹ì…˜ ë²ˆí˜¸ì— ë§ê²Œ ì •í™•íˆ ë§¤í•‘
            for (let i = 0; i < 4; i++) {
                const sectionNumber = i + 1;
                const section = sections.find(s => s.number === sectionNumber);
                let content = section ? section.content : 'í•´ë‹¹ ì—†ìŒ';
                
                // ì˜¤íƒ€ ìˆ˜ì •
                content = content.replace(/ì„ì‚¬/g, 'ì…ì‚¬');
                content = content.replace(/ìš´ë³´ë”©/g, 'ì˜¨ë³´ë”©');
                
                // ì§„í–‰ë¥  í˜•ì‹ í†µì¼: "- 90% ì§„í–‰" â†’ "(90%)"
                content = content.replace(/- (\d+)% ì§„í–‰/g, '($1%)');
                content = content.replace(/- (\d+)%\s*ì§„í–‰/g, '($1%)');
                
                // "ì—…ë¬´ëª…: n% â†’ m% ì§„í–‰" â†’ "ì—…ë¬´ëª… (n% -> m%)"
                content = content.replace(/([^:]+):\s*(\d+)%\s*â†’\s*(\d+)%\s*ì§„í–‰/g, '$1 ($2% -> $3%)');
                
                // "- [ë²ˆí˜¸-] ì—…ë¬´ëª… - ì§„í–‰ë¥ " â†’ "â€¢ ì—…ë¬´ëª… (ì§„í–‰ë¥ )"
                content = content.replace(/- \[([^\]]*)\] ([^-]+) - (\d+)% ì§„í–‰/g, 'â€¢ $2 ($3%)');
                content = content.replace(/- \[([^\]]*)\] ([^-]+) - (\d+)%\s*ì§„í–‰/g, 'â€¢ $2 ($3%)');
                
                // ëª¨ë“  í•˜ì´í”ˆì„ bulletìœ¼ë¡œ ë³€ê²½
                content = content.replace(/^- /gm, 'â€¢ ');
                content = content.replace(/<br>- /g, '<br>â€¢ ');
                
                // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
                content = content.replace(/\n/g, '<br>');
                
                tableHtml += `<td class="section-content">${content}</td>`;
            }
            
            tableHtml += `
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            return tableHtml;
        }

        // ì´ë¯¸ì§€ ë¹„êµ í‘œì‹œ í•¨ìˆ˜
        function displayImageComparison(mondayImages, fridayImages) {
            const mondayDisplay = document.getElementById('monday-images-display');
            const fridayDisplay = document.getElementById('friday-images-display');
            const imageComparison = document.getElementById('image-comparison');
            
            // ì›”ìš”ì¼ ì´ë¯¸ì§€ í‘œì‹œ
            mondayDisplay.innerHTML = '';
            mondayImages.forEach((img, index) => {
                const container = createImageContainer(img, 'monday', index);
                mondayDisplay.appendChild(container);
            });
            
            // ê¸ˆìš”ì¼ ì´ë¯¸ì§€ í‘œì‹œ
            fridayDisplay.innerHTML = '';
            fridayImages.forEach((img, index) => {
                const container = createImageContainer(img, 'friday', index);
                fridayDisplay.appendChild(container);
            });
            
            imageComparison.classList.remove('hidden');
        }
        
        function createImageContainer(imageData, group, index) {
            const container = document.createElement('div');
            container.className = 'image-container';
            container.id = `${group}-image-${index}`;
            
            container.innerHTML = `
                <div class="image-title">${imageData.filename}</div>
                <img src="${imageData.path}" alt="${imageData.filename}">
            `;
            
            
            return container;
        }
        
        
        

        // ë‹¬ë ¥ ê¸°ëŠ¥
        class Calendar {
            constructor(prefix) {
                this.prefix = prefix;
                this.currentDate = new Date();
                this.selectedDate = null;
                this.isOpen = false;
                this.storageKey = `calendar_${prefix}_date`;
                this.init();
                this.loadSavedDate();
            }

            init() {
                const button = document.getElementById(`${this.prefix}-date-button`);
                const calendar = document.getElementById(`${this.prefix}-calendar`);
                const prevBtn = document.getElementById(`${this.prefix}-prev-month`);
                const nextBtn = document.getElementById(`${this.prefix}-next-month`);

                button.addEventListener('click', () => this.toggleCalendar());
                prevBtn.addEventListener('click', () => this.prevMonth());
                nextBtn.addEventListener('click', () => this.nextMonth());

                // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹¬ë ¥ ë‹«ê¸°
                document.addEventListener('click', (e) => {
                    if (!document.getElementById(`${this.prefix}-date-dropdown`).contains(e.target)) {
                        this.closeCalendar();
                    }
                });

                this.render();
            }

            toggleCalendar() {
                this.isOpen = !this.isOpen;
                const calendar = document.getElementById(`${this.prefix}-calendar`);
                calendar.style.display = this.isOpen ? 'block' : 'none';
            }

            closeCalendar() {
                this.isOpen = false;
                const calendar = document.getElementById(`${this.prefix}-calendar`);
                calendar.style.display = 'none';
            }

            prevMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.render();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.render();
            }

            getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }

            render() {
                const monthYear = document.getElementById(`${this.prefix}-month-year`);
                const grid = document.getElementById(`${this.prefix}-calendar-grid`);

                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();

                monthYear.textContent = `${year}ë…„ ${month + 1}ì›”`;

                // ë‹¬ë ¥ ê·¸ë¦¬ë“œ ìƒì„±
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay()); // ì¼ìš”ì¼ë¶€í„° ì‹œì‘

                let html = '<div class="calendar-weekdays">';
                const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                weekdays.forEach(day => {
                    html += `<div class="weekday">${day}</div>`;
                });
                html += '</div><div class="calendar-dates">';

                for (let i = 0; i < 42; i++) { // 6ì£¼
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const isCurrentMonth = date.getMonth() === month;
                    const isToday = date.toDateString() === new Date().toDateString();
                    const isSelected = this.selectedDate && date.toDateString() === this.selectedDate.toDateString();
                    
                    let classes = ['calendar-date'];
                    if (!isCurrentMonth) classes.push('other-month');
                    if (isToday) classes.push('today');
                    if (isSelected) classes.push('selected');

                    const weekNum = this.getWeekNumber(date);
                    
                    html += `<div class="${classes.join(' ')}" data-date="${date.toISOString()}" title="ì£¼ì°¨: ${weekNum}">
                        ${date.getDate()}
                    </div>`;
                }
                html += '</div>';

                grid.innerHTML = html;

                // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸
                grid.querySelectorAll('.calendar-date').forEach(dateEl => {
                    dateEl.addEventListener('click', () => {
                        const date = new Date(dateEl.dataset.date);
                        this.selectDate(date);
                    });
                });
            }

            selectDate(date) {
                this.selectedDate = date;
                const weekNum = this.getWeekNumber(date);
                const formattedDate = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} (${weekNum}ì£¼ì°¨)`;
                
                document.getElementById(`${this.prefix}-selected-date`).textContent = formattedDate;
                this.closeCalendar();
                this.render();
                
                // localStorageì— ë‚ ì§œ ì €ì¥
                this.saveDate(date);
                
                // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸
                updateDateRange();
            }

            saveDate(date) {
                localStorage.setItem(this.storageKey, date.toISOString());
            }

            loadSavedDate() {
                const savedDate = localStorage.getItem(this.storageKey);
                if (savedDate) {
                    const date = new Date(savedDate);
                    this.selectedDate = date;
                    this.currentDate = new Date(date.getFullYear(), date.getMonth(), 1);
                    
                    const weekNum = this.getWeekNumber(date);
                    const formattedDate = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} (${weekNum}ì£¼ì°¨)`;
                    document.getElementById(`${this.prefix}-selected-date`).textContent = formattedDate;
                    
                    // ë¡œë“œ ì™„ë£Œ í›„ ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—°
                    setTimeout(() => {
                        updateDateRange();
                    }, 100);
                }
            }
        }

        // ë‚ ì§œ ë²”ìœ„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateDateRange() {
            const mondayDate = mondayCalendar.selectedDate;
            const fridayDate = fridayCalendar.selectedDate;
            const dateRangeText = document.getElementById('date-range-text');
            
            if (mondayDate && fridayDate) {
                const startDate = mondayDate <= fridayDate ? mondayDate : fridayDate;
                const endDate = mondayDate <= fridayDate ? fridayDate : mondayDate;
                
                const startWeek = mondayCalendar.getWeekNumber(startDate);
                const endWeek = mondayCalendar.getWeekNumber(endDate);
                
                const startStr = `${startDate.getFullYear()}/${startDate.getMonth() + 1}/${startDate.getDate()}`;
                const endStr = `${endDate.getFullYear()}/${endDate.getMonth() + 1}/${endDate.getDate()}`;
                
                if (startWeek === endWeek) {
                    dateRangeText.textContent = `${startStr}~${endStr} (${startWeek}ì£¼ì°¨)`;
                } else {
                    dateRangeText.textContent = `${startStr}~${endStr} (${startWeek}~${endWeek}ì£¼ì°¨)`;
                }
            } else if (mondayDate) {
                const weekNum = mondayCalendar.getWeekNumber(mondayDate);
                const dateStr = `${mondayDate.getFullYear()}/${mondayDate.getMonth() + 1}/${mondayDate.getDate()}`;
                dateRangeText.textContent = `ì›”ìš”ì¼: ${dateStr} (${weekNum}ì£¼ì°¨)`;
            } else if (fridayDate) {
                const weekNum = fridayCalendar.getWeekNumber(fridayDate);
                const dateStr = `${fridayDate.getFullYear()}/${fridayDate.getMonth() + 1}/${fridayDate.getDate()}`;
                dateRangeText.textContent = `ê¸ˆìš”ì¼: ${dateStr} (${weekNum}ì£¼ì°¨)`;
            } else {
                dateRangeText.textContent = 'ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
            }
        }

        // ë‹¬ë ¥ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const mondayCalendar = new Calendar('monday');
        const fridayCalendar = new Calendar('friday');

        // ë“œë¡­ì¡´ ì´ˆê¸°í™”
        document.querySelectorAll('.drop-zone').forEach(setupDropZone);

        // ë…¸ì…˜ ë¶„ì„ í•¨ìˆ˜
        function analyzeNotionData() {
            const mondayDate = mondayCalendar.selectedDate;
            const fridayDate = fridayCalendar.selectedDate;
            
            if (!mondayDate || !fridayDate) {
                showMessage('ì›”ìš”ì¼ê³¼ ê¸ˆìš”ì¼ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const notionLoading = document.getElementById('notion-loading');
            const notionResults = document.getElementById('notion-results');
            const notionBtn = document.getElementById('notion-analyze-btn');
            
            notionLoading.classList.remove('hidden');
            notionResults.classList.add('hidden');
            notionBtn.disabled = true;
            
            // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const mondayStr = mondayDate.toISOString().split('T')[0];
            const fridayStr = fridayDate.toISOString().split('T')[0];
            
            fetch('/notion-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    monday_date: mondayStr,
                    friday_date: fridayStr
                })
            })
            .then(response => response.json())
            .then(data => {
                notionLoading.classList.add('hidden');
                notionBtn.disabled = false;
                
                if (data.success) {
                    displayNotionResults(data.analysis);
                    notionResults.classList.remove('hidden');
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                notionLoading.classList.add('hidden');
                notionBtn.disabled = false;
                showMessage('ë…¸ì…˜ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                console.error('Error:', error);
            });
        }
        
        function displayNotionResults(analysis) {
            // ì—…ë¬´ ê°œìˆ˜ í‘œì‹œ
            document.getElementById('monday-task-count').textContent = analysis.monday_tasks;
            document.getElementById('friday-task-count').textContent = analysis.friday_tasks;
            
            // ìƒíƒœë³„ ì—…ë¬´ ë³€í™” ì°¨íŠ¸
            displayStatusChart(analysis.status_comparison);
            
            // ìš°ì„ ìˆœìœ„ ë¶„í¬ ì°¨íŠ¸
            displayPriorityChart(analysis.priority_distribution);
            
            // ì¹´í…Œê³ ë¦¬ë³„ ì—…ë¬´ ì°¨íŠ¸
            displayCategoryChart(analysis.category_distribution);
        }
        
        function displayStatusChart(statusData) {
            const chartDiv = document.getElementById('status-chart');
            let html = '<div class="status-bars">';
            
            for (const [status, counts] of Object.entries(statusData)) {
                const mondayCount = counts.monday || 0;
                const fridayCount = counts.friday || 0;
                const change = fridayCount - mondayCount;
                const changeClass = change > 0 ? 'increase' : change < 0 ? 'decrease' : 'same';
                const changeText = change > 0 ? `+${change}` : change < 0 ? `${change}` : 'Â±0';
                
                // ìƒíƒœëª…ì—ì„œ ë²ˆí˜¸ì™€ ì´ëª¨ì§€ ì œê±°
                const cleanStatus = status.replace(/^\d+\.\s*[ğŸ”„â•â©âŒ›âœ…â›”â¯ï¸]*\s*/, '');
                
                html += `
                    <div class="status-item">
                        <div class="status-name">${cleanStatus}</div>
                        <div class="status-comparison">
                            <div class="day-count monday">ì›”: ${mondayCount}</div>
                            <div class="day-count friday">ê¸ˆ: ${fridayCount}</div>
                            <div class="change ${changeClass}">${changeText}</div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }
        
        function displayPriorityChart(priorityData) {
            const chartDiv = document.getElementById('priority-chart');
            let html = '<div class="priority-items">';
            
            const sortedPriorities = Object.entries(priorityData).sort((a, b) => b[1] - a[1]);
            
            for (const [priority, count] of sortedPriorities) {
                const cleanPriority = priority.replace(/[ğŸš¨ğŸ…°ï¸ğŸ…±ï¸Â©ï¸â““]+/g, '').replace(/\d+ï¸âƒ£/g, '');
                html += `
                    <div class="priority-item">
                        <span class="priority-name">${cleanPriority || priority}</span>
                        <span class="priority-count">${count}ê°œ</span>
                    </div>
                `;
            }
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }
        
        function displayCategoryChart(categoryData) {
            const chartDiv = document.getElementById('category-chart');
            let html = '<div class="category-items">';
            
            const sortedCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
            
            for (const [category, count] of sortedCategories) {
                // ì¹´í…Œê³ ë¦¬ëª…ì—ì„œ ë²ˆí˜¸ ì œê±°
                const cleanCategory = category.replace(/^\d+\./, '');
                html += `
                    <div class="category-item">
                        <span class="category-name">${cleanCategory}</span>
                        <span class="category-count">${count}ê°œ</span>
                    </div>
                `;
            }
            
            html += '</div>';
            chartDiv.innerHTML = html;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('compare-btn').addEventListener('click', compareImages);
        document.getElementById('notion-analyze-btn').addEventListener('click', analyzeNotionData);
    </script>
</body>
</html>